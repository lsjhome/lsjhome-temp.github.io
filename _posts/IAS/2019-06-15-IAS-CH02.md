---
layout: post
title: Chapter 02. 스파크의 처리 모델
comments: true
categories: [Intro to Apache Spark]
tags: [Spark]
author: lsjhome
---

## 2.1 스파크의 기본적인 자료구조 RDD

### 2.1.1 RDD 구조와 특징

RDD는 대량의 데이터를 요소로 가지는 분산 컬랙션이다. RDD는 여러 머신으로 구성된 클러스터 환경에서의 분산처리를 전제로 설계되었고 내부는 파티션이라는 단위로 나뉜다. 스파크에서는 이 파티션이 분산처리 단위다. RDD를 파티션 단위로 여러 머신에서 처리하므로, 한 대의 머신으로 처리할 수 있는 것보다 더 큰 데이터를 다룰 수 있다.

RDD는 불변(immutable)하다. 즉 내부 요소 값이 변경 불가능하며 생성이나 변환이 지연 평가되는 성질이 있다.

### 2.1.2 RDD 다루기

RDD에는 변환과 액션 두 종류의 처리가 있다. 

변환은 RDD를 가공하고 새로운 RDD를 얻는 처리다. 변환처리 후의 RDD가 가지는 요소는 변환처리 전의 RDD에 들어있던 요소를 가공하거나 필터링해 생성된다.

첫째는 변환처리 전의 RDD가 가지는 요소를, 같은 RDD의 다른 요소들과 관계없이 처리할 수 있는 종류다.

- filter
  - 요소를 필터링한다.
  - 도형을 요소로 가지는 RDD에서 삼각형을 필터링
- map
  - 각 요소에 동일한 처리를 적용한다.
  - 식재료를 요소로 가지는 RDD를 식재료를 품목으로 분류한 RDD
- flatmap
  - 각 요소에 동일한 처리를 적용하고 여러 개의 요소를 생성
  - 문장을 요소로 가지는 RDD를 단어로 분해된 RDD로
- zip
  - 파티션 수가 같고, 파티션의 요소의 수도 같은 두 개의 RDD를 조합해 한쪽의 요소 값을 키로, 다른 한쪽 요소 값을 벨류로 가지는 쌍
  - 한국어로 된 동물 이름을 가지는 RDD, 영어로 된 동물 이름을 가지는 RDD => 한국어와 영어 동물 이름이 쌍을 이루는 RDD

둘째는 변환전의 RDD가 가지는 요소를 같은 RDD의 다른 요소와 함께 처리하는 변환이다. 그 변환 대상은 키와 벨류의 쌍을 요소로 가지는 RDD다. 같은 키를 가지는 요소가 같은 파티션에 있어야 하는데, 스파크는 파티션 단위로 독립해 분산처리하기 때문이다. 이때 다른 파티션에 있는 같은 키를 가지는 요소와 자리를 바꾸는 것을 **셔플**이라 한다.

셔플은 변환하기 전의 RDD 요소를 변환 후에 키를 기준으로 각 파티션에 배분한다. 따라서 셔플에 의해 같은 키를 가지는 요소가 같은 파티션에 있도록 보증할 수 있다.

- reduceByKey
  - 같은 키를 가지는 요소를 집약처리한다.
- join
  - 두 개의 RDD에서 같은 키를 가지는 요소끼리 조인한다.

액션(action)

변환이 RDD로부터 다른 RDD를 얻는 데이터 가공에 해당하는 조작이면, <u>액션은 RDD 내용을 바탕으로 데이터를 가공하지 않고 결과를 얻는 조작이다.</u>

- saveAsTextFile
  - RDD의 내용을 파일로 출력한다.
- count
  - RDD의 요소 수를 센다.

## 2.2 스파크 분산처리 환경

### 2.2.1 클러스터 환경 개요

스파크는 여러 머신으로 구성된 클러스터 환경에서의 동작을 전제로 한 분산처리 시스템이다. 클러스터 내의 계산 리소스를 관리하는 기능이 필요하다. 이를 클러스터 관리 시스템이라 한다.

- YARN
  하둡의 클러스터 관리 시스템이다. 분산처리를 위한 범용 클러스터 관리 시스템으로 설계되어, 스파크 이외의 분산처리 프레임워크를 돌릴 수 있다. 하둡의 분산파일시스템인 HDFS를 이용할 경우, 클러스터 관리 시스템으로 YARN을 사용할 경우 데이터 지역성이 고려되어 효율적인 I/O가 가능하다.
- Mesos
  YARN처럼 범용 클러스터 관리 시스템이다. 처리에 할당하는 CPU 코어 수의 분배를 동적으로 바꿀 수 있는 세세한 제어가 가능하다.
- Spark Standalone
  스파크 번들되는 전용 클러스터 관리 시스템이다. 별도의 클러스터 관리 시스템 없이 편리하게 사용 가능하다.

클러스터 관리 시스템 하에서 각 머신은 마스터 혹은 워커 노드로 동작한다. 마스터는 클러스터 내의 계산 리소스를 집중하며 관리 역할을 담당한다. 한편 워커 노드는 CPU 코어와 메모리 등의 계산 리소스를 제공하고 할당된 처리를 실행한다.

**애플리케이션 배포와 계산 리소스 요구**
스파크로 분산처리할때는 RDD 생성과 일련의 변환으로 구성된 스파크 애플리케이션을 클라이언트가 클러스터에 배포한다.

클라이언트는 애플리케이션을 배포함과 동시에 이 애플리케이션 실행에 필요한 이그제큐터(executor)의 스펙을 지정한다. 이그제큐터란 워커 노드에서 구동하며 스파크 애플리케이션을 분산처리하는 프로세스를 뜻한다. 이그제큐터의 스펙으로는 CPU 코어 수의 할당량과 메모리 할당량, 클러스터 내에서 구동할 이그제큐터 수를 지정할 수 있다.

**클러스터 내 계산 리소스 확보**
클러스터에 애플리케이션이 배포되면, 마스터 노드는 각 워커 노드의 이용 간으한 리소스양과 클라이언트가 요청하는 이그제큐너 스펙을 고려하여 하나 이상의 워커 노드에 이그제큐터의 구동을 요구한다.

**드라이버 프로그램 구동**
클러스터 내에 리소스가 확보됨과 동시에 '드라이버 프로그램'이 구동한다. 드라이버 프로그램이란 사용자에 의해 정의되는 스파크 애필리케이션의 엔트리 포인트가 되는 프로그램이다. 사용자가 기술한 RDD의 생성 및 변환 로직을 이용해 애플리케이션을 제어하는 역할을 담당한다.

**태스크 스케줄링과 실행**
스파크 애플리케이션은 RDD 생성부터 액션 적용까지를 통틀어 잡(job)이라는 단위로 처리한다. 잡은 **태스크** 라는 단위로 분할되며, 그 실행이 스케줄링된다. 태스크는 파티션 단위로 데이터를 로드하고 변환과 액션을 적용하는 처리 단위이다. 이그제큐터가 각 태스크를 처리함으로써 RDD전체가 분산처리 되는 것이다.

### 2.2.2 드라이버 프로그램

스파크 애플리케이션의 동작을 제어하는 것은 '드라이버 프로그램' 이다. 드라이버 프로그램에 RDD의 생성과 변환, 액션의 로직 등을 기술한다. 실제 처리는 드라이버 프로그램에서 이루어지지않으며 잡 형태로 클러스터에서 실행된다. 그리고 실행 시점은 드라이버 프로그램에서 액션의 적용이 선언될 때까지 지연된다.

### 2.2.3 태스크 스케줄링

RDD의 생성과 로드는 지연평가이므로(lazy evaluation), RDD가 데이터를 가진 상태가 되는 것은 클러스터를 처리할 때다. 드라이버 프로그램에서 생성된 RDD에는 태스크 작성과 스케줄링에 필요한 정보가 포함된다. 

### 2.2.4 RDD 영속화

이그제큐터는 태스크 처리르 끝날 때, 처리 과정에서 생성된 파티션 인스턴스를 영속화하는 경우가 있따. 스파크에서는 RDD가 다음 조건 중 하나라도 만족하면 영속화한다.

- 셔플에서 발생하는 변환을 실행하기 직전의 RDD
- 사용자에 의해서 명시적으로 영속화가 선언된 RDD